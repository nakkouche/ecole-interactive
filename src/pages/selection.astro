---
import Layout from '../layouts/Layout.astro';
import { loadAllQCMs, getMatieres } from '../lib/qcmParser';

// Charger tous les QCM disponibles
const allQCMs = await loadAllQCMs();
const matieres = getMatieres(allQCMs);

// Grouper les QCM par mati√®re
const qcmsByMatiere = matieres.map((matiere) => ({
  matiere,
  qcms: allQCMs.filter((qcm) => qcm.frontmatter.matiere === matiere),
}));

// Ic√¥nes et couleurs par mati√®re
const matiereConfig: {
  [key: string]: { icon: string; colorClass: string };
} = {
  Math√©matiques: { icon: 'üî¢', colorClass: 'bg-blue-100 border-blue-300 hover:bg-blue-200' },
  Fran√ßais: { icon: 'üìö', colorClass: 'bg-green-100 border-green-300 hover:bg-green-200' },
  Sciences: { icon: 'üî¨', colorClass: 'bg-purple-100 border-purple-300 hover:bg-purple-200' },
  Histoire: { icon: 'üèõÔ∏è', colorClass: 'bg-orange-100 border-orange-300 hover:bg-orange-200' },
  G√©ographie: { icon: 'üåç', colorClass: 'bg-pink-100 border-pink-300 hover:bg-pink-200' },
  Anglais: { icon: 'üá¨üáß', colorClass: 'bg-yellow-100 border-yellow-300 hover:bg-yellow-200' },
};

// Mapper la difficult√© en √©toiles
function getDifficultyStars(difficulte: number): string {
  return '‚≠ê'.repeat(Math.min(difficulte, 5));
}
---

<Layout title="√âcole Interactive - S√©lection">
  <div class="mx-auto max-w-6xl">
    <div class="mb-12 text-center">
      <h1 id="page-title" class="mb-4 text-5xl font-bold text-gray-800">
        Quelle mati√®re veux-tu r√©viser ?
      </h1>
      <p id="page-subtitle" class="text-xl text-gray-600">
        Choisis une mati√®re pour commencer √† apprendre !
      </p>
    </div>

    <div class="mb-8 text-center flex gap-4 justify-center">
      <a
        href={`${import.meta.env.BASE_URL}matieres`}
        class="inline-block rounded-xl bg-gray-200 px-6 py-3 text-lg font-semibold text-gray-700 transition-all hover:bg-gray-300"
      >
        ‚Üê Retour aux mati√®res
      </a>
      <a
        href={import.meta.env.BASE_URL}
        class="inline-block rounded-xl bg-gray-200 px-6 py-3 text-lg font-semibold text-gray-700 transition-all hover:bg-gray-300"
      >
        üë§ Changer d'utilisateur
      </a>
    </div>

    {
      qcmsByMatiere.length === 0 ? (
        <div class="rounded-3xl bg-white p-12 text-center shadow-lg">
          <div class="mb-4 text-6xl">üì≠</div>
          <h2 class="mb-2 text-3xl font-bold text-gray-800">Aucun QCM disponible</h2>
          <p class="text-xl text-gray-600">
            Les QCM n'ont pas encore √©t√© ajout√©s. Consultez le README pour ajouter des QCM.
          </p>
        </div>
      ) : (
        <div id="qcms-container" class="space-y-10">
          {
            qcmsByMatiere.map(({ matiere, qcms }) => {
              const config = matiereConfig[matiere] || { icon: 'üìñ', colorClass: 'bg-gray-100 border-gray-300 hover:bg-gray-200' };
              return (
                <div class="matiere-section rounded-3xl bg-white p-8 shadow-lg" data-matiere={matiere}>
                  <div class="mb-6 flex items-center gap-4">
                    <span class="text-5xl">{config.icon}</span>
                    <div>
                      <h2 class="text-3xl font-bold text-gray-800">{matiere}</h2>
                      <p class="text-lg text-gray-600">{qcms.length} QCM disponible{qcms.length > 1 ? 's' : ''}</p>
                    </div>
                  </div>

                  <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                    {
                      qcms.map((qcm) => (
                        <a
                          href={`${import.meta.env.BASE_URL}qcm/${qcm.frontmatter.id}`}
                          class={`block rounded-xl border-4 p-6 transition-all hover:scale-105 active:scale-95 ${config.colorClass}`}
                        >
                          <h3 class="mb-2 text-lg font-bold text-gray-800 line-clamp-2">
                            {qcm.frontmatter.titre}
                          </h3>
                          <p class="mb-3 text-sm text-gray-600 line-clamp-2">
                            {qcm.frontmatter.description}
                          </p>
                          <div class="flex flex-wrap gap-2 text-xs">
                            <span class="rounded-full bg-white px-3 py-1 font-semibold text-gray-700">
                              {qcm.frontmatter.niveau}
                            </span>
                            <span class="rounded-full bg-white px-3 py-1 font-semibold text-gray-700">
                              {getDifficultyStars(qcm.frontmatter.difficulte)}
                            </span>
                            <span class="rounded-full bg-white px-3 py-1 font-semibold text-gray-700">
                              {qcm.frontmatter.points} pts
                            </span>
                          </div>
                        </a>
                      ))
                    }
                  </div>
                </div>
              );
            })
          }
        </div>
      )
    }
  </div>

  <script>
    // Filtrage c√¥t√© client bas√© sur le param√®tre URL
    function filterByMatiere() {
      const urlParams = new URLSearchParams(window.location.search);
      const selectedMatiere = urlParams.get('matiere');

      const pageTitle = document.getElementById('page-title');
      const pageSubtitle = document.getElementById('page-subtitle');
      const matiereSections = document.querySelectorAll('.matiere-section');

      if (selectedMatiere) {
        // Mettre √† jour le titre et sous-titre
        if (pageTitle) pageTitle.textContent = `QCM de ${selectedMatiere}`;
        if (pageSubtitle) pageSubtitle.textContent = 'Choisis un QCM pour commencer !';

        // Filtrer les sections de mati√®res
        matiereSections.forEach((section) => {
          const matiere = section.getAttribute('data-matiere');
          if (matiere === selectedMatiere) {
            (section as HTMLElement).style.display = 'block';
          } else {
            (section as HTMLElement).style.display = 'none';
          }
        });
      } else {
        // Afficher toutes les sections si aucune mati√®re n'est s√©lectionn√©e
        matiereSections.forEach((section) => {
          (section as HTMLElement).style.display = 'block';
        });
      }
    }

    // Ex√©cuter le filtrage au chargement de la page
    filterByMatiere();

    // R√©-ex√©cuter si l'URL change (navigation avec le bouton retour/avancer)
    window.addEventListener('popstate', filterByMatiere);
  </script>
</Layout>
