---
import Layout from '../layouts/Layout.astro';
import { loadAllQCMs, getMatieres } from '../lib/qcmParser';

// Charger tous les QCM disponibles
const allQCMs = await loadAllQCMs();
const matieres = getMatieres(allQCMs);

// Compter les QCM par mati√®re et par niveau
const qcmsByMatiere = matieres.map((matiere) => {
  const qcmsForMatiere = allQCMs.filter((qcm) => qcm.frontmatter.matiere === matiere);
  const niveaux = [...new Set(qcmsForMatiere.map((qcm) => qcm.frontmatter.niveau))];

  return {
    matiere,
    count: qcmsForMatiere.length,
    niveaux: niveaux,
    countByNiveau: {
      CP: qcmsForMatiere.filter((qcm) => qcm.frontmatter.niveau === 'CP').length,
      CE1: qcmsForMatiere.filter((qcm) => qcm.frontmatter.niveau === 'CE1').length,
      CE2: qcmsForMatiere.filter((qcm) => qcm.frontmatter.niveau === 'CE2').length,
      CM1: qcmsForMatiere.filter((qcm) => qcm.frontmatter.niveau === 'CM1').length,
      CM2: qcmsForMatiere.filter((qcm) => qcm.frontmatter.niveau === 'CM2').length,
    }
  };
});

// Ic√¥nes et couleurs par mati√®re
const matiereConfig: {
  [key: string]: { icon: string; colorClass: string };
} = {
  Math√©matiques: { icon: 'üî¢', colorClass: 'bg-gradient-to-br from-blue-100 to-blue-200 border-blue-300 hover:from-blue-200 hover:to-blue-300' },
  Fran√ßais: { icon: 'üìö', colorClass: 'bg-gradient-to-br from-green-100 to-green-200 border-green-300 hover:from-green-200 hover:to-green-300' },
  Sciences: { icon: 'üî¨', colorClass: 'bg-gradient-to-br from-purple-100 to-purple-200 border-purple-300 hover:from-purple-200 hover:to-purple-300' },
  Histoire: { icon: 'üèõÔ∏è', colorClass: 'bg-gradient-to-br from-orange-100 to-orange-200 border-orange-300 hover:from-orange-200 hover:to-orange-300' },
  G√©ographie: { icon: 'üåç', colorClass: 'bg-gradient-to-br from-pink-100 to-pink-200 border-pink-300 hover:from-pink-200 hover:to-pink-300' },
  Anglais: { icon: 'üá¨üáß', colorClass: 'bg-gradient-to-br from-yellow-100 to-yellow-200 border-yellow-300 hover:from-yellow-200 hover:to-yellow-300' },
};
---

<Layout title="√âcole Interactive - Choix de la mati√®re">
  <div class="mx-auto max-w-6xl">
    <div class="mb-12 text-center">
      <h1 class="mb-4 text-5xl font-bold text-gray-800">Quelle mati√®re veux-tu r√©viser ?</h1>
      <p class="text-xl text-gray-600">Choisis une mati√®re pour commencer √† apprendre !</p>
    </div>

    <div class="mb-8 text-center">
      <a
        href={import.meta.env.BASE_URL}
        class="inline-block rounded-xl bg-gray-200 px-6 py-3 text-lg font-semibold text-gray-700 transition-all hover:bg-gray-300"
      >
        ‚Üê Changer d'utilisateur
      </a>
    </div>

    {
      qcmsByMatiere.length === 0 ? (
        <div class="rounded-3xl bg-white p-12 text-center shadow-lg">
          <div class="mb-4 text-6xl">üì≠</div>
          <h2 class="mb-2 text-3xl font-bold text-gray-800">Aucune mati√®re disponible</h2>
          <p class="text-xl text-gray-600">
            Les QCM n'ont pas encore √©t√© ajout√©s. Consultez le README pour ajouter des QCM.
          </p>
        </div>
      ) : (
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3" id="matieres-grid">
          {
            qcmsByMatiere.map(({ matiere, count, niveaux, countByNiveau }) => {
              const config = matiereConfig[matiere] || {
                icon: 'üìñ',
                colorClass: 'bg-gradient-to-br from-gray-100 to-gray-200 border-gray-300 hover:from-gray-200 hover:to-gray-300'
              };
              return (
                <a
                  href={`${import.meta.env.BASE_URL}selection?matiere=${encodeURIComponent(matiere)}`}
                  class={`matiere-card block rounded-3xl border-4 p-8 text-center shadow-lg transition-all hover:scale-105 hover:shadow-xl active:scale-95 ${config.colorClass}`}
                  data-matiere={matiere}
                  data-niveaux={JSON.stringify(niveaux)}
                  data-count-cp={countByNiveau.CP}
                  data-count-ce1={countByNiveau.CE1}
                  data-count-ce2={countByNiveau.CE2}
                  data-count-cm1={countByNiveau.CM1}
                  data-count-cm2={countByNiveau.CM2}
                >
                  <div class="mb-4 text-7xl">{config.icon}</div>
                  <h2 class="mb-2 text-3xl font-bold text-gray-800">{matiere}</h2>
                  <p class="text-lg text-gray-600 matiere-count">
                    {count} QCM disponible{count > 1 ? 's' : ''}
                  </p>
                </a>
              );
            })
          }
        </div>
      )
    }
  </div>

  <script>
    // Filtrage des mati√®res par classe de l'utilisateur
    function filterMatieresByClasse() {
      // R√©cup√©rer la classe de l'utilisateur depuis localStorage
      const storedUser = localStorage.getItem('ecole_user');
      if (!storedUser) {
        // Si pas d'utilisateur connect√©, rediriger vers la page d'accueil
        window.location.href = import.meta.env.BASE_URL;
        return;
      }

      const user = JSON.parse(storedUser);
      const classe = user.classe;

      // R√©cup√©rer toutes les cartes de mati√®res
      const matiereCards = document.querySelectorAll('.matiere-card');
      let visibleCount = 0;

      matiereCards.forEach((card) => {
        const countAttr = `data-count-${classe.toLowerCase()}`;
        const count = parseInt(card.getAttribute(countAttr) || '0');

        if (count > 0) {
          // Afficher la carte et mettre √† jour le compteur
          (card as HTMLElement).style.display = 'block';
          const countElement = card.querySelector('.matiere-count');
          if (countElement) {
            countElement.textContent = `${count} QCM disponible${count > 1 ? 's' : ''}`;
          }
          visibleCount++;
        } else {
          // Cacher la carte si aucun QCM disponible pour cette classe
          (card as HTMLElement).style.display = 'none';
        }
      });

      // Afficher un message si aucune mati√®re n'est disponible pour cette classe
      const grid = document.getElementById('matieres-grid');
      if (grid && visibleCount === 0) {
        grid.innerHTML = `
          <div class="col-span-full rounded-3xl bg-white p-12 text-center shadow-lg">
            <div class="mb-4 text-6xl">üì≠</div>
            <h2 class="mb-2 text-3xl font-bold text-gray-800">Aucune mati√®re disponible pour ${classe}</h2>
            <p class="text-xl text-gray-600">
              Il n'y a pas encore de QCM disponibles pour la classe ${classe}.
            </p>
            <a
              href="${import.meta.env.BASE_URL}"
              class="mt-6 inline-block rounded-xl bg-blue-500 px-6 py-3 text-lg font-semibold text-white transition-all hover:bg-blue-600"
            >
              Changer de classe
            </a>
          </div>
        `;
      }
    }

    // Ex√©cuter le filtrage au chargement de la page
    filterMatieresByClasse();
  </script>
</Layout>
